version: 2.1

jobs:
  forecast_job:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project

    steps:
      - checkout

      # Cache: safe key based on pyproject.toml (poetry.lock may not exist)
      - restore_cache:
          keys:
            - v1-deps-{{ .Branch }}-{{ checksum "pyproject.toml" }}
            - v1-deps-{{ .Branch }}-
            - v1-deps-

      - run:
          name: Show Python version
          command: python --version

      - run:
          name: Install Poetry + configure venv in project
          command: |
            python -m pip install --upgrade pip
            pip install --no-cache-dir poetry
            poetry config virtualenvs.in-project true

      - run:
          name: Install dependencies
          command: |
            poetry install --no-interaction --no-root

      - save_cache:
          key: v1-deps-{{ .Branch }}-{{ checksum "pyproject.toml" }}
          paths:
            - .venv
            - .cache/pypoetry

      - run:
          name: Run forecasting bot
          command: |
            poetry run python forecasting_bot.py --mode tournament --tournament spring-2026-ai minibench

workflows:
  hourly_forecast:
    triggers:
      - schedule:
          cron: "0 * * * *"
          filters:
            branches:
              only:
                - main
    jobs:
      - forecast_job